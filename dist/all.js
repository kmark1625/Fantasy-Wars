function Battle(t,e){this.map=t,this.players=e,this.turn=1,this.currentSelectedUnit=null,this.currentSelectedMovement=[],this.currentSelectedAttacks=[],this.currentSelectedTile=null,this.currentCaptureTile=null,this.turnState="selectingUnit",this.canClick=!0,this.computerCanClick=!0,this.currentPlayer=1,this.buildScreen=null,this.unitSpriteDisplay=null,this.captureText=null,this.map.remakeAllFlags()}function BuildScreen(t,e,a){this.armyList=t,this.battle=e,this.createPos=a,this.buttons=[],this.backdrop=null,this.text1=[],this.text2=null,this.onCreate()}function Pos(t,e,a){this.x=t,this.y=e,this.parentPos=a||null}function Map(){}function Army(t){this.units=t}function ArmyDwarf(t){this.units=t,this.armyList=[Warrior,Grenadier,Mech,MotorBike,IronGuard,Mortar,Cannon,Biplane]}function ArmyElf(t){this.units=t,this.armyList=[Longbow,Elite,Arcanist,Ranger,SilverLancer,Valkyrie,Ballista,EagleWatch]}function ArmyOrc(t){this.units=t,this.armyList=[Warmonger,Impaler,Berserker,Salamander,GilaMonster,Catapult,BloodWing,Wyvern]}function ComputerPlayer(t){this.army=t,this.active=!1,this.mode=null,this.battle=null}function Player(t){this.army=t,this.gold=500,this.active=!1}function Mode(t){this.battle=t}function Unit(t,e){this.player=e,this.pos=t,this.health=100,this.damageTaken=0,this.speed=3,this.movedThisTurn=!1,this.range=[1,1],this.walkPath=[],this.attacking=!1,this.alive=!0,this.healthText=null}function UnitArtillery(t,e){this.pos=t}function UnitCavalry(t){this.pos=t}function UnitFlying(t){this.pos=t}function UnitInfantry(t){this.pos=t}function AggressiveMode(t){this.battle=t,this.enemyHQPos=this._getEnemyHQPos(),this.usedPositionsThisTurn=[],this.currentSelectedUnit=null,this.buildPhase=!1}function DefaultMode(t){this.battle=t}function DefensiveMode(t){this.battle=t,this.enemyHQPos=this._getEnemyHQPos(),this.usedPositionsThisTurn=[],this.currentSelectedUnit=null,this.buildPhase=!1}function PatrolMode(){this.battle=battle}function Biplane(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprDwarves"+e),game.add.existing(this),this.animations.add("stand",[80,81],8),this.animations.add("move",[82,83],12),this.animations.add("attack",[84,85,86,87],12),this.name="Dwarf Biplane",this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("machineGun"),this.health=100,this.attack=50,this.defense=.2,this.speed=8,this.range=[1,2],this.cost=400,this.player=e}function Cannon(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprDwarves"+e),game.add.existing(this),this.animations.add("stand",[50,51],2),this.animations.add("move",[52,53],8),this.animations.add("attack",[54,55,56,57],8),this.name="Dwarf Cannon",this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("cannonShot"),this.health=100,this.attack=120,this.defense=.2,this.speed=3,this.range=[2,4],this.cost=1e3,this.player=e}function Grenadier(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprDwarves"+e),game.add.existing(this),this.animations.add("stand",[10,11],2),this.animations.add("move",[12,13],8),this.animations.add("attack",[14,15,16,17],8),this.name="Dwarf Grenadier",this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("rifle"),this.health=100,this.attack=50,this.defense=.2,this.speed=3,this.range=[1,2],this.cost=150,this.player=e}function IronGuard(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprDwarves"+e),game.add.existing(this),this.animations.add("stand",[30,31],2),this.animations.add("move",[32,33],8),this.animations.add("attack",[34,35,36,37],8),this.name="Dwarf IronGuard",this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.health=100,this.attack=75,this.defense=.4,this.speed=3,this.range=[1,1],this.cost=400,this.player=e}function Mech(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprDwarves"+e),game.add.existing(this),this.animations.add("stand",[20,21],2),this.animations.add("move",[22,23],8),this.animations.add("attack",[24,25],2),this.name="Dwarf Mech",this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("cannonShot"),this.health=100,this.attack=100,this.defense=.2,this.speed=2,this.range=[1,2],this.cost=200,this.player=e}function Mortar(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprDwarves"+e),game.add.existing(this),this.animations.add("stand",[60,61],2),this.animations.add("move",[62,63],8),this.animations.add("attack",[64,65,66,67],8),this.name="Dwarf Mortar",this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("mortarShot"),this.health=100,this.attack=90,this.defense=.2,this.speed=3,this.range=[3,5],this.cost=900,this.player=e}function MotorBike(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprDwarves"+e),game.add.existing(this),this.animations.add("stand",[40,41],8),this.animations.add("move",[42,43],12),this.animations.add("attack",[44,45,46,47],12),this.name="Dwarf MotorBike",this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("rifle"),this.health=100,this.attack=50,this.defense=.2,this.speed=6,this.range=[1,2],this.cost=200,this.player=e}function Warrior(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprDwarves"+e),game.add.existing(this),this.animations.add("stand",[0,1],2),this.animations.add("move",[2,3],8),this.animations.add("attack",[4,5,6,7],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Dwarf Warrior",this.health=100,this.attack=55,this.defense=.2,this.speed=3,this.range=[1,1],this.cost=100,this.player=e}function Arcanist(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprElves"+e),game.add.existing(this),this.animations.add("stand",[20,21],2),this.animations.add("move",[22,23],8),this.animations.add("attack",[24,25,26,27],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("flash"),this.name="Elf Arcanist",this.health=100,this.attack=75,this.defense=0,this.speed=4,this.range=[2,3],this.cost=300,this.player=e}function Ballista(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprElves"+e),game.add.existing(this),this.animations.add("stand",[60,61],2),this.animations.add("move",[62,63],8),this.animations.add("attack",[64,65,66,67],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("bow"),this.name="Elf Ballista",this.health=100,this.attack=80,this.defense=0,this.speed=4,this.range=[2,4],this.cost=600,this.player=e}function EagleWatch(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprElves"+e),game.add.existing(this),this.animations.add("stand",[70,71],2),this.animations.add("move",[72,73],8),this.animations.add("attack",[74,75,76,77],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Elf EagleWatch",this.health=100,this.attack=65,this.defense=0,this.speed=9,this.range=[1,1],this.cost=600,this.player=e}function Elite(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprElves"+e),game.add.existing(this),this.animations.add("stand",[10,11],2),this.animations.add("move",[12,13],8),this.animations.add("attack",[14,15,16,17],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Elf Elite",this.health=100,this.attack=75,this.defense=.2,this.speed=4,this.range=[1,1],this.cost=300,this.player=e}function Longbow(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprElves"+e),game.add.existing(this),this.animations.add("stand",[0,1],2),this.animations.add("move",[2,3],8),this.animations.add("attack",[4,5,6,7],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Elf Longbow",this.health=100,this.attack=45,this.defense=.1,this.speed=4,this.range=[1,2],this.cost=100,this.player=e}function Ranger(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprElves"+e),game.add.existing(this),this.animations.add("stand",[30,31],2),this.animations.add("move",[32,33],8),this.animations.add("attack",[34,35,36,37],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("bow"),this.name="Elf Ranger",this.health=100,this.attack=45,this.defense=.1,this.speed=8,this.range=[1,2],this.cost=250,this.player=e}function SilverLancer(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprElves"+e),game.add.existing(this),this.animations.add("stand",[40,41],2),this.animations.add("move",[42,43],8),this.animations.add("attack",[44,45],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Elf SilverLancer",this.health=100,this.attack=75,this.defense=.3,this.speed=7,this.range=[1,1],this.cost=600,this.player=e}function Valkyrie(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprElves"+e),game.add.existing(this),this.animations.add("stand",[50,51],2),this.animations.add("move",[52,53],8),this.animations.add("attack",[54,55,56,57],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("flash"),this.name="Elf Valkyrie",this.health=100,this.attack=65,this.defense=0,this.speed=7,this.range=[2,3],this.cost=500,this.player=e}function Berserker(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprOrcs"+e),game.add.existing(this),this.animations.add("stand",[20,21],2),this.animations.add("move",[22,23],8),this.animations.add("attack",[24,25,26,27],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Orc Berserker",this.health=120,this.attack=90,this.defense=0,this.speed=4,this.range=[1,1],this.cost=400,this.player=e}function BloodWing(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprOrcs"+e),game.add.existing(this),this.animations.add("stand",[60,61],2),this.animations.add("move",[62,63],8),this.animations.add("attack",[64,65,66,67],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Orc BloodWing",this.health=100,this.attack=65,this.defense=.1,this.speed=7,this.range=[1,1],this.cost=300,this.player=e}function Catapult(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprOrcs"+e),game.add.existing(this),this.animations.add("stand",[50,51],2),this.animations.add("move",[52,53],8),this.animations.add("attack",[54,55,56,57],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("mortarShot"),this.name="Orc Catapult",this.health=100,this.attack=90,this.defense=.1,this.speed=3,this.range=[3,4],this.cost=500,this.player=e}function GilaMonster(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprOrcs"+e),game.add.existing(this),this.animations.add("stand",[40,41],2),this.animations.add("move",[42,43],8),this.animations.add("attack",[44,45,46,47],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Orc GilaMonster",this.health=100,this.attack=90,this.defense=.3,this.speed=6,this.range=[1,1],this.cost=600,this.player=e}function Impaler(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprOrcs"+e),game.add.existing(this),this.animations.add("stand",[10,11],2),this.animations.add("move",[12,13],8),this.animations.add("attack",[14,15,16,17],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("bow"),this.name="Orc Impaler",this.health=100,this.attack=45,this.defense=.1,this.speed=3,this.range=[1,2],this.cost=100,this.player=e}function Salamander(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprOrcs"+e),game.add.existing(this),this.animations.add("stand",[30,31],2),this.animations.add("move",[32,33],8),this.animations.add("attack",[34,35,36,37],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Orc Salamander",this.health=100,this.attack=55,this.defense=.1,this.speed=7,this.range=[1,1],this.cost=250,this.player=e}function Warmonger(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprOrcs"+e),game.add.existing(this),this.animations.add("stand",[0,1],2),this.animations.add("move",[2,3],8),this.animations.add("attack",[4,5,6,7],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Orc Warmonger",this.health=100,this.attack=60,this.defense=.2,this.speed=3,this.range=[1,1],this.cost=200,this.player=e}function Wyvern(t,e){this.pos=t,Phaser.Sprite.call(this,game,t.canvasX(),t.canvasY(),"sprOrcs"+e),game.add.existing(this),this.animations.add("stand",[70,71],2),this.animations.add("move",[72,73],8),this.animations.add("attack",[74,75,76,77],8),this.moveSound=game.add.audio("move"),this.attackSound=game.add.audio("slash"),this.name="Orc Wyvern",this.health=150,this.attack=100,this.defense=.2,this.speed=6,this.range=[1,2],this.cost=800,this.player=e}Battle.prototype.update=function(){for(var t=0;t<this.players.length;t++)this.players[t].update(this.map,this.turn===t+1);"animatingMovement"===this.turnState?this.animateMovement():"animatingAttack"===this.turnState?this.animateAttack():this.onClickListener(),"selectingMove"!==this.turnState&&moveHighlights.removeChildren(),"capturePrompt"===this.turnState?this.displayCaptureText():null!==this.captureText&&(this.captureText.destroy(),this.captureText=null),"selectingAttack"!==this.turnState&&"capturePrompt"!==this.turnState&&attackHighlights.removeChildren(),this.updateUnitSpriteDisplay(),this.checkVictoryConditions()},Battle.prototype.displayCaptureText=function(){if(null===this.captureText){var t={font:"10px Arial",fill:"orange",strokeThickness:3,align:"center"};this.captureText=game.add.text(this.currentSelectedUnit.x+16,this.currentSelectedUnit.y+16,"Capture?",t),this.captureText.anchor.setTo(.5,.5),game.add.tween(this.captureText.scale).to({x:1.1,y:1.1},300,"Linear",!0,0,-1,!0)}},Battle.prototype.getUnitAtPos=function(t){return finalUnit=null,this.players.forEach(function(e){e.army.units.forEach(function(e){e.pos.equals(t)&&(finalUnit=e)})}),finalUnit},Battle.prototype.onClickListener=function(){if(game.input.activePointer.leftButton.isDown&&this.canClick||this._isComputerTurn()&&this.computerCanClick){if(this._isComputerTurn()){this.computerCanClick=!1;var t=this.players[1].handleComputerMove()}else var t=new Pos(Math.floor(game.input.activePointer.worldX/TILESCALE),Math.floor(game.input.activePointer.worldY/TILESCALE));this.canClick=!1,t||(t=new Pos(0,0)),"buildUnit"!==this.turnState&&(this.currentSelectedTile=this.map.getTileAtPos(t)),"selectingUnit"===this.turnState?this._clickListenerTurnStateSelectingUnitHelper(t):"selectingMove"===this.turnState?this._clickListenerTurnStateSelectingMoveHelper(t):"selectingAttack"===this.turnState?this._clickListenerTurnStateSelectingAttackHelper(t):"capturePrompt"===this.turnState?this._clickListenerTurnStateCapturePromptHelper(t):"buildUnit"===this.turnState&&this._clickListenerTurnStateBuildUnitHelper(t)}game.input.activePointer.leftButton.isUp&&!this._isComputerTurn()&&(this.canClick=!0)},Battle.prototype.tileIsBuilding=function(t){return"castle"===t.name||"barracks"===t.name||"town"===t.name},Battle.prototype.animateMovement=function(){var t=this.currentSelectedUnit.pos.x,e=this.currentSelectedUnit.pos.y;if(this.currentSelectedUnit.move()){var a=this;this.turnState="selectingAttack",this.currentSelectedMovement=[],this.currentSelectedAttacks=this.currentSelectedUnit.getPossibleAttacks(this.map);var i=!1;this.enemyPositions().forEach(function(t){a.arrayIncludesPosition(a.currentSelectedAttacks,t)&&(i=!0,a.getUnitAtPos(t)instanceof UnitFlying&&1===a.currentSelectedUnit.range[1]&&(i=!1))});var n=a.currentSelectedUnit,s=this.currentSelectedUnit.pos.x!==t||this.currentSelectedUnit.pos.y!==e;(!i||this.currentSelectedUnit instanceof UnitArtillery&&s)&&(a.turnState="selectingUnit",a.currentSelectedUnit=null,a.currentSelectedMovement=[],a.currentSelectedAttacks=[]),this.tileIsBuilding(this.currentSelectedTile)&&n instanceof UnitInfantry&&parseInt(this.currentSelectedTile.owner)!==this.currentPlayer&&(this.currentSelectedUnit=n,a.turnState="capturePrompt",a.currentSelectedMovement=[],a.currentCaptureTile=this.currentSelectedTile),this._isComputerTurn()||this.renderAttackHighlights()}},Battle.prototype.animateAttack=function(){this.currentSelectedUnit.attackAnim()&&(this.turnState="selectingUnit",this.currentSelectedUnit.attacking=!1,this.currentSelectedUnit=null,this.currentSelectedMovement=[],this.currentSelectedAttacks=[])},Battle.prototype.getMoveAtPos=function(t){return finalSquare=null,this.currentSelectedMovement.forEach(function(e){t.equals(e)&&(finalSquare=e)}),finalSquare},Battle.prototype.getUnitToAttackAtPos=function(t){return finalSquare=null,this.currentSelectedAttacks.forEach(function(e){t.equals(e)&&(finalSquare=e)}),null===finalSquare?null:this.getUnitAtPos(finalSquare)},Battle.prototype.renderMoveHighlights=function(){var t=this.currentSelectedMovement.slice();t.forEach(function(t){moveHighlights.create(t.canvasX(),t.canvasY(),"selectionTiles",0)}),moveHighlights.callAll("animations.add","animations","move",[0,1,2],4,!0),moveHighlights.callAll("animations.play","animations","move")},Battle.prototype.renderAttackHighlights=function(){var t=this.currentSelectedAttacks.slice();t=t.map(function(t){attackHighlights.create(t.canvasX(),t.canvasY(),"selectionTiles",10)}),attackHighlights.callAll("animations.add","animations","attack",[3,4,5],4,!0),attackHighlights.callAll("animations.play","animations","attack")},Battle.prototype.getTileAtPos=function(t){return this.map.getTileAtPos(t)},Battle.prototype.switchTurn=function(){},Battle.prototype.enemyPositions=function(){return this.players[this.players.length-(this.currentPlayer-1)-1].unitPositions()},Battle.prototype.arrayIncludesPosition=function(t,e){var a=!1;return t.forEach(function(t){if(e.equals(t))return void(a=!0)}),a},Battle.prototype.unitCombat=function(t,e,a){var i=0;i=e instanceof UnitFlying?e.takeDamage(t.getAttackDamage(e.defense,0)):e.takeDamage(t.getAttackDamage(e.defense,a)),this._displayDamageTaken(i,e,t),0===a&&1===e.range[0]&&e.getHealthNumber()>0&&(i=t instanceof UnitFlying?e.range[1]>1?t.takeDamage(e.getAttackDamage(t.defense,0)):0:t.takeDamage(e.getAttackDamage(t.defense,a)),this._displayDamageTaken(i,t,e))},Battle.prototype._clickListenerTurnStateSelectingAttackHelper=function(t){var e=this.getUnitToAttackAtPos(t);null===e||e.player===this.currentSelectedUnit.player?(this.turnState="selectingUnit",this.currentSelectedUnit=null,this.currentSelectedAttack=[]):(this.turnState="animatingAttack",this.currentSelectedUnit.attacking=!0,this.currentSelectedUnit.animations.play("attack"),1===this.currentSelectedUnit.distanceTo(e.pos)?this.unitCombat(this.currentSelectedUnit,e,0):this.unitCombat(this.currentSelectedUnit,e,this.map.getTileAtPos(e.pos).protection),this.currentSelectedAttack=[],this.currentSelectedUnit.alive===!1&&(this.currentSelectedUnit.attackSound.play(),e.attackSound.play(),this.turnState="selectingUnit",this.currentSelectedUnit.attacking=!1,this.currentSelectedUnit=null,this.currentSelectedMovement=[],this.currentSelectedAttacks=[])),this.computerCanClick=!0},Battle.prototype._clickListenerTurnStateSelectingMoveHelper=function(t){var e=this.getMoveAtPos(t),a=this.getUnitAtPos(t);if(null===e||null!==a&&a!==this.currentSelectedUnit)this.turnState="selectingUnit",this.currentSelectedUnit=null,this.currentSelectedMovement=[];else if(this.currentSelectedUnit.movedThisTurn||this.currentSelectedUnit.player!==this.currentPlayer)this.turnState="selectingUnit",this.currentSelectedUnit=null,this.currentSelectedMovement=[];else{var i=this.currentSelectedUnit.moveSound;i.play(),this.turnState="animatingMovement",this.currentSelectedUnit.walkPath=e.getPath()}this.computerCanClick=!0},Battle.prototype._clickListenerTurnStateCapturePromptHelper=function(t){if(this.getTileAtPos(t)===this.currentCaptureTile){var e=this.currentCaptureTile.capturePoints;e=parseInt(e)+this.currentSelectedUnit.getHealthNumber(),this.currentCaptureTile.capturePoints=e.toString(),this._displayCaptureProgress(e,this.currentSelectedUnit),e>=20?(this.currentCaptureTile.owner=this.currentPlayer,this.currentCaptureTile.capturePoints="0",game.add.audio("complete").play(),this.map.remakeAllFlags()):game.add.audio("capture").play(),this.turnState="selectingUnit",this.currentSelectedUnit=null,this.currentSelectedMovement=[],this.currentSelectedAttacks=[]}else this._clickListenerTurnStateSelectingAttackHelper(t);this.currentCaptureTile=null,this.computerCanClick=!0},Battle.prototype._clickListenerTurnStateSelectingUnitHelper=function(t){unit=this.getUnitAtPos(t),unit?this.currentSelectedUnit!==unit&&(this.currentSelectedUnit=unit,this.currentSelectedMovement=this.currentSelectedUnit.getPossibleMoves(this.currentSelectedUnit.pos,this.map,this.enemyPositions()),this.turnState="selectingMove",this._isComputerTurn()||this.renderMoveHighlights()):this.clickOnBarracks(t),this.computerCanClick=!0},Battle.prototype._clickListenerTurnStateBuildUnitHelper=function(t){var e=this.buildScreen.onClick(t);if(e){e.movedThisTurn=!0;var a=game.add.filter("Gray");e.filters=[a],this.getCurrentPlayer().army.units.push(e),game.add.audio("purchase",2).play()}this.buildScreen=this.buildScreen.destroy(),this.turnState="selectingUnit",currentPlayerGold.setText("Gold: "+battle.players[battle.currentPlayer-1].gold),this.currentSelectedUnit=null,this.computerCanClick=!0},Battle.prototype.clickOnBarracks=function(t){this.currentSelectedTile=this.map.getTileAtPos(t),this.currentSelectedTile&&"barracks"===this.currentSelectedTile.name&&parseInt(this.currentSelectedTile.owner)===this.currentPlayer&&(this.turnState="buildUnit",this.buildScreen=new BuildScreen(this.getCurrentPlayer().army.armyList,this,t))},Battle.prototype.addGold=function(){var t=this;this.map.getAllBuildingsForPlayer(this.currentPlayer).forEach(function(e){t.getCurrentPlayer().gold+=100})},Battle.prototype.getCurrentPlayer=function(){return this.players[this.currentPlayer-1]},Battle.prototype._displayDamageTaken=function(t,e,a){var i={font:"12px Arial",backgroundColor:"red",fill:"#ffffff",strokeThickness:3,align:"center"},n=game.add.text(e.pos.canvasX()+16,e.pos.canvasY(),"-"+t,i);n.anchor.set(.5),n.alpha=1;game.add.tween(n).to({alpha:0,y:e.pos.canvasY()-20},2e3,"Linear",!0)},Battle.prototype._displayCaptureProgress=function(t,e){if(t<20)var a={font:"24px Arial",fill:"#00e5e6",align:"center",stroke:"black",strokeThickness:3},i=game.add.text(e.pos.canvasX()+16,e.pos.canvasY(),t/20*100+"% Captured!",a);else var a={font:"24px Arial",fill:"#ff9900",align:"center",stroke:"white",strokeThickness:3},i=game.add.text(e.pos.canvasX()+16,e.pos.canvasY(),"Captured!",a);i.anchor.set(.5),i.alpha=1;game.add.tween(i).to({alpha:0,y:e.pos.canvasY()-20},1500,"Linear",!0)},Battle.prototype._isComputerTurn=function(){return this.players[1]instanceof ComputerPlayer&&2===this.currentPlayer},Battle.prototype.updateUnitSpriteDisplay=function(){if(null!==this.currentSelectedUnit){var t=this.currentSelectedUnit.constructor;if(null===this.unitSpriteDisplay||t!==this.unitSpriteDisplay.constructor){null!==this.unitSpriteDisplay&&(this.unitSpriteDisplay.destroy(),this.unitSpriteDisplay=null);var e=this.unitSpriteDisplay=new t(new Pos(20,7),this.currentSelectedUnit.player);e.scale.x=3,e.scale.y=3,e.animations.play("stand",2,!0)}}else null!==this.unitSpriteDisplay&&(this.unitSpriteDisplay.destroy(),this.unitSpriteDisplay=null)},Battle.prototype.checkVictoryConditions=function(){if(this.checkLosingConditionsforPlayer(this.players[0],1)===!0)game.state.start("victoryState",!0,!1,"Player 2");else{if(this.checkLosingConditionsforPlayer(this.players[1],2)!==!0)return!1;game.state.start("victoryState",!0,!1,"Player 1")}},Battle.prototype.checkLosingConditionsforPlayer=function(t,e){if(0===t.army.units.length||this.didPlayerLoseHQ(e))return!0},Battle.prototype.didPlayerLoseHQ=function(t){var e=!0;return this.map.getAllBuildingsForPlayer(t).forEach(function(t){"castle"===t.name&&(e=!1)}),e},BuildScreen.prototype.onCreate=function(){var t=this;this.backdrop=game.add.image(4*TILESCALE,2*TILESCALE,"unitBuildScreen"),this.backdrop.width=320,this.backdrop.height=320,this.backdrop.alpha=0,game.add.tween(this.backdrop).to({scaleX:320,scaleY:320,alpha:1,x:4*TILESCALE,y:2*TILESCALE-16},500,"Linear",!0),this.armyList.forEach(function(e,a){unit=new e(new Pos(5,3+a),this.battle.currentPlayer);var i=this.battle.getCurrentPlayer().gold>=unit.cost?"white":"red";t.text1.push(game.add.text(6*TILESCALE+8,unit.pos.canvasY()+8,unit.name+"....GOLD: "+unit.cost,{font:"14px Arial",fill:i})),unit.animations.play("stand",5,!0),t.buttons.push(unit)}),this.text2=game.add.text(5*TILESCALE,2*TILESCALE,"Click unit to build:",{font:"16px Arial",fill:"white",align:"left"})},BuildScreen.prototype.onClick=function(t){if(unitIndex=null,this.buttons.forEach(function(e,a){e.pos.equals(t)&&e.cost<=this.battle.getCurrentPlayer().gold&&(unitIndex=a)}),null===unitIndex)return null;var e=new this.armyList[unitIndex](this.createPos,this.battle.currentPlayer);return this.battle.getCurrentPlayer().gold-=e.cost,e},BuildScreen.prototype.destroy=function(){var t=this;return this.backdrop.destroy(),this.text2.destroy(),this.text1.forEach(function(e,a){t.buttons[a].destroy(),e.destroy()}),null},Pos.prototype.getCoordinates=function(){return[this.x,this.y]},Pos.prototype.canvasX=function(){return this.x*TILESCALE},Pos.prototype.canvasY=function(){return this.y*TILESCALE},Pos.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},Pos.prototype.getPath=function(){return null===this.parentPos?[this]:[this].concat(this.parentPos.getPath())},Map.prototype.getTileAtPos=function(t){var e=game.world.cursor.map,a=e.getTile(t.x,t.y);return a?a.properties:a},Map.prototype.getPenaltyAtPos=function(t,e){var a=this.getTileAtPos(t);return e instanceof UnitInfantry?parseInt(a.movCostInf):e instanceof UnitArtillery?parseInt(a.movCostArt):e instanceof UnitFlying?parseInt(a.movCostFly):e instanceof UnitCavalry?parseInt(a.movCostCav):1},Map.prototype.posValid=function(t){var e=game.world.cursor.map;return t.x>=0&&t.x<e.width&&t.y>=0&&t.y<e.height},Map.prototype.getAllBuildings=function(t){for(var e=[],a=game.world.cursor.map,i=0;i<a.width;i++)for(var n=0;n<a.height;n++){var s=a.getTile(i,n);void 0!==s.properties.owner&&(t?e.push([s.properties,i,n]):e.push(s.properties))}return e},Map.prototype.getAllBuildingsForPlayer=function(t){var e=[];return this.getAllBuildings().forEach(function(a){parseInt(a.owner)===t&&e.push(a)}),e},Map.prototype.remakeAllFlags=function(){flags.removeChildren(),this.getAllBuildings(!0).forEach(function(t){if(1===parseInt(t[0].owner))var e="red_flag";else var e="blue_flag";if(0!==parseInt(t[0].owner)){game.add.sprite(t[1]*TILESCALE,t[2]*TILESCALE+4,e)}})},Map.prototype.getArmyForPlayer=function(t,e){var a=[],i=game.world.cursor.map.objects.units;return i.forEach(function(i){parseInt(i.properties.player)===t&&(pos=new Pos(i.x/TILESCALE,i.y/TILESCALE),a.push(new(e[parseInt(i.properties.unitIndex)])(pos,t)))}),a},Army.prototype.update=function(t){this.removeDeadUnits(),this.units.forEach(function(e){e.updateUnit(t)})},Army.prototype.removeDeadUnits=function(){for(var t=this.units.length-1;t>=0;t--)this.units[t].alive||this.units.splice(t,1)},ArmyDwarf.prototype=new Army,ArmyDwarf.prototype.constructor=ArmyDwarf,ArmyElf.prototype=new Army,ArmyElf.prototype.constructor=ArmyElf,ArmyOrc.prototype=new Army,ArmyOrc.prototype.constructor=ArmyOrc,ComputerPlayer.prototype=new Player,ComputerPlayer.prototype.constructor=ComputerPlayer,ComputerPlayer.prototype.update=function(t,e){this.army.update(t)},ComputerPlayer.prototype.handleComputerMove=function(){return this.mode.handleComputerMove()},ComputerPlayer.prototype.updateMode=function(t){switch(t){case"aggressive":this.mode=new AggressiveMode(this.battle);break;case"defensive":this.mode=new DefensiveMode(this.battle);break;case"patrol":this.mode=new PatrolMode(this.battle);break;default:this.mode=new DefaultMode(this.battle)}},Player.prototype.update=function(t,e){this.army.update(t)},Player.prototype.unitPositions=function(){return this.army.units.map(function(t){return t.pos})},Player.prototype.onTurnStart=function(t,e){this.army.units.forEach(function(a){var i=t.getTileAtPos(a.pos);if(void 0!==parseInt(i.owner)&&parseInt(i.owner)===e){var n=a.damageTaken;a.damageTaken-=Math.floor(a.health/5),a.damageTaken<0&&(a.damageTaken=0);var s=n-a.damageTaken;if(s>0){var r={font:"12px Arial",backgroundColor:"green",fill:"#ffffff",strokeThickness:3,align:"center"},o=game.add.text(a.pos.canvasX()+16,a.pos.canvasY(),"+"+s,r);o.anchor.set(.5),o.alpha=1;game.add.tween(o).to({alpha:0,y:a.pos.canvasY()-20},1500,"Linear",!0)}}})},Player.prototype.openMenu=function(){},Player.prototype.endTurn=function(){this.army.units.forEach(function(t){t.resetUnit()})},Player.prototype.quitGame=function(){},Player.prototype.armyType=function(){return this.army instanceof ArmyDwarf?"dwarves":this.army instanceof ArmyElf?"elves":this.army instanceof ArmyOrc?"orcs":null},Mode.prototype.execute=function(){},Mode.prototype._endTurn=function(){battle.players[1].endTurn(),battle.currentPlayer=1;var t=battle.getCurrentPlayer().gold;battle.addGold(),t!==battle.getCurrentPlayer().gold&&game.add.audio("coin").play(),battle.getCurrentPlayer().onTurnStart(battle.map,battle.currentPlayer);var e={font:"65px Arial",fill:"#ff0044",align:"center",stroke:"white",strokeThickness:5},a=game.add.text(game.world.centerX-210,game.world.centerY-300,"Player 1 Turn",e);a.anchor.set(.5),a.alpha=1;game.add.tween(a).to({alpha:0},2e3,"Linear",!0);battle.turn++,turnCount.setText("Turn: "+battle.turn),currentPlayerText.setText("Player "+this.battle.currentPlayer),currentPlayerGold.setText("Gold: "+this.battle.players[battle.currentPlayer-1].gold);var i=null;i=Math.random()>.05?"aggressive":"defensive",this.battle.players[1].updateMode(i)},Mode.prototype._getEnemyHQPos=function(){var t=this,e=null,a=(this.battle.players[0],this.battle.map.getAllBuildings(!0));return a.forEach(function(a){"castle"===a[0].name&&1===parseInt(a[0].owner)&&(e=t._getBarracksPosition(a))}),e},Mode.prototype._getDistanceBetween=function(t,e){return Math.sqrt(Math.pow(Math.abs(t.x-e.x),2)+Math.pow(Math.abs(t.y-e.y),2))},Mode.prototype.arrayIncludesPosition=function(t,e){var a=!1;return t.forEach(function(t){if(e.equals(t))return void(a=!0)}),a},Mode.prototype.handleComputerMove=function(){var t;return this.buildPhase===!0?"buildUnit"!==this.battle.turnState?this._isOpenBarracks()&&this.battle.getCurrentPlayer().gold>=100?t=this._selectNextBarracks():(this.buildPhase=!1,this._endTurn()):"buildUnit"===this.battle.turnState&&(t=this._findUnitMousePos()):t="selectingUnit"===this.battle.turnState?this._selectNextUnit():"selectingMove"===this.battle.turnState?this._selectNextMove():"selectingAttack"===this.battle.turnState?this._selectNextAttack():"capturePrompt"===this.battle.turnState?this._selectNextCapture():new Pos(1,1),t},Mode.prototype._unitOnMyBarracks=function(t){return!!this.battle.getUnitAtPos(t)},Mode.prototype._isOpenBarracks=function(){var t=this._getAllMyOpenBarracks();return t.length>0},Mode.prototype._getAllMyBarracksPositions=function(){var t=this,e=[];return this._getAllBarracks().forEach(function(a){e.push(t._getBarracksPosition(a))}),e},Mode.prototype._getAllMyOpenBarracks=function(){var t=this,e=[];return this._getAllMyBarracksPositions().forEach(function(a){t._unitOnMyBarracks(a)||e.push(a)}),e},Mode.prototype._selectNextBarracks=function(){if(this._isOpenBarracks()){var t=this._getAllMyOpenBarracks()[0];return this.battle.currentSelectedTile=this.battle.map.getTileAtPos(t),t}return null},Mode.prototype._getAllBarracks=function(){var t=this,e=[];return this.battle.map.getAllBuildings(!0).forEach(function(a){"barracks"===a[0].name&&parseInt(a[0].owner)===t.battle.currentPlayer&&e.push(a)}),e},Mode.prototype._getBarracksPosition=function(t){
var e=new Pos(parseInt(t[1]),parseInt(t[2]));return e},Mode.prototype._getMostExpensiveAffordableUnit=function(){var t=this.battle.getCurrentPlayer().armyType(),e=null,a=null,i=0,n=-1,s=[];for(var r in UNITS[t])n+=1,UNITS[t][r]>i&&UNITS[t][r]<=this.battle.getCurrentPlayer().gold&&(i=UNITS[t][r],e=r,a=n);return s.push(e),s.push(a),s},Mode.prototype._findUnitMousePos=function(){var t=this._getMostExpensiveAffordableUnit(),e=(t[0],t[1]),a=new Pos(5,3+e);return a},Mode.prototype._selectNextUnit=function(){var t=null,e=this;return this.battle.players[1].army.units.forEach(function(a){t||a.movedThisTurn||(e.currentSelectedUnit=a,t=a.pos)}),null===t&&(this.buildPhase=!0),t},Mode.prototype._selectNextMove=function(){var t=this,e=null,a=this.currentSelectedUnit.getPossibleMoves(this.currentSelectedUnit.pos,this.battle.map,this.battle.enemyPositions()),i=this._filterPossibleMoves(a),n=this.battle.map.getAllBuildings(!0),s=!1;return n.forEach(function(e){1===parseInt(e[0].owner)&&t._getBarracksPosition(e).equals(t.currentSelectedUnit.pos)&&(s=!0)}),e=this.currentSelectedUnit instanceof UnitArtillery?t._handleArtilleryMovement(i):this.currentSelectedUnit instanceof UnitInfantry&&s?t.currentSelectedUnit.pos:this._randomizeUnitMovement(i)},Mode.prototype._selectNextAttack=function(){var t=this.currentSelectedUnit.getPossibleAttacks(this.battle.map),e=this._filterPossibleAttackMoves(t);return e[0]},Mode.prototype._selectNextCapture=function(){return this.currentSelectedUnit.pos},Mode.prototype._filterPossibleMoves=function(t){var e=this;return result=[],t.forEach(function(t){var a=e.battle.getUnitAtPos(t);a||result.push(t)}),result},Mode.prototype._filterPossibleAttackMoves=function(t){var e=this;return result=[],t.forEach(function(t){var a=e.battle.getUnitAtPos(t);a&&a.player!==e.currentSelectedUnit.player&&result.push(t)}),result},Mode.prototype._getClosestMoveToEnemyHQ=function(t){var e=this;return bestMove=null,bestMoveDistance=100,t.forEach(function(t){var a=e._getDistanceBetween(e.enemyHQPos,t);a<bestMoveDistance&&(bestMove=t,bestMoveDistance=a)}),bestMove},Mode.prototype._getClosestMoveToEnemyUnit=function(t){var e=this;return bestMove=null,bestMoveDistance=100,this.battle.enemyPositions().forEach(function(a){t.forEach(function(t){var i=e._getDistanceBetween(a,t);i<bestMoveDistance&&(bestMove=t,bestMoveDistance=i)})}),bestMove},Mode.prototype._randomizeUnitMovement=function(t){var e=null;return e=Math.random()>.5?this._getClosestMoveToEnemyHQ(t):this._getClosestMoveToEnemyUnit(t)},Mode.prototype._handleArtilleryMovement=function(t){var e=null,a=Math.random();return e=a>.5?this.currentSelectedUnit.pos:this._randomizeUnitMovement(t)},Unit.prototype=Object.create(Phaser.Sprite.prototype),Unit.prototype.constructor=Unit,Unit.prototype.updateUnit=function(t,e){this.updateDisplayHealth(),0!==this.walkPath.length||this.attacking||(this.animations.play("stand"),this.x=this.pos.canvasX(),this.y=this.pos.canvasY())},Unit.prototype.grayOut=function(){var t=game.add.filter("Gray");this.filters=[t]},Unit.prototype.attackAnim=function(){return this.attackSound.play("",0,1,!1,!1),this.animations.currentAnim.isFinished},Unit.prototype.move=function(){this.animations.play("move");var t=this.walkPath[this.walkPath.length-1];return!t||(t.canvasX()>this.x&&(this.x+=2,this.scale.x=1,this.anchor.setTo(0,0)),t.canvasX()<this.x&&(this.x-=2,this.scale.x=-1,this.anchor.setTo(1,0)),t.canvasY()>this.y&&(this.y+=2),t.canvasY()<this.y&&(this.y-=2),t.canvasX()===this.x&&t.canvasY()===this.y&&(this.pos.x=this.walkPath[this.walkPath.length-1].x,this.pos.y=this.walkPath[this.walkPath.length-1].y,this.walkPath.pop()),0===this.walkPath.length&&(this.movedThisTurn=!0,this.grayOut()),0===this.walkPath.length)},Unit.prototype.getPossibleMoves=function(t,e,a){for(var i=this,n=[t],s=[],r=[0],o=0;s.length<n.length;)this.getSurroundingPos(n[o]).forEach(function(t){e.posValid(t)&&!i.arrayIncludesPosition(a,t)&&(i.arrayIncludesPosition(n,t)||r[n.indexOf(n[o])]+e.getPenaltyAtPos(t,i)<=i.speed&&(n.push(t),r.push(r[n.indexOf(n[o])]+e.getPenaltyAtPos(t,i))))}),this.arrayIncludesPosition(s,n[o])||s.push(n[o]),o++;return n},Unit.prototype.arrayIncludesPosition=function(t,e){var a=!1;return t.forEach(function(t){if(e.equals(t))return void(a=!0)}),a},Unit.prototype.getSurroundingPos=function(t){return[new Pos(t.x,t.y+1,t),new Pos(t.x+1,t.y,t),new Pos(t.x,t.y-1,t),new Pos(t.x-1,t.y,t)]},Unit.prototype.getPossibleAttacks=function(t){for(var e=[],a=this.pos.x-this.range[1];a<=this.pos.x+this.range[1];a++)for(var i=this.pos.y-this.range[1];i<=this.pos.y+this.range[1];i++){var n=new Pos(a,i);t.posValid(n)&&this.distanceTo(n)>=this.range[0]&&this.distanceTo(n)<=this.range[1]&&e.push(n)}return e},Unit.prototype.distanceTo=function(t){return Math.abs(this.pos.x-t.x)+Math.abs(this.pos.y-t.y)},Unit.prototype.takeDamage=function(t){return this.damageTaken+=t,this.damageTaken>=this.health&&this.die(),t},Unit.prototype.getHealthNumber=function(){return Math.ceil((this.health-this.damageTaken)/(this.health/10))},Unit.prototype.getDefenseAsPercent=function(){return 100*this.defense+"%"},Unit.prototype.getAttackDamage=function(t,e){return Math.floor(this.attack*((this.health-this.damageTaken)/this.health)*(1-t)*(1-e)*(Math.random()/10+1))},Unit.prototype.die=function(){game.add.tween(this).to({alpha:0},1e3,"Linear",!0),this.alive=!1,this.healthText.destroy(),this.destroy()},Unit.prototype.resetUnit=function(){this.movedThisTurn=!1,this.filters=null},Unit.prototype.updateDisplayHealth=function(){var t={font:"12px Arial",fill:"white",strokeThickness:3};null===this.healthText&&(this.healthText=game.add.text(this.x+16,this.y+16,"",t)),this.healthText.x=this.x+16,this.healthText.y=this.y+16,0===this.damageTaken?this.healthText.text="":this.healthText.text=this.getHealthNumber()},UnitArtillery.prototype=new Unit,UnitArtillery.prototype.constructor=UnitArtillery,UnitCavalry.prototype=new Unit,UnitCavalry.prototype.constructor=UnitCavalry,UnitFlying.prototype=new Unit,UnitFlying.prototype.constructor=UnitFlying,UnitInfantry.prototype=new Unit,UnitInfantry.prototype.constructor=UnitInfantry,AggressiveMode.prototype=new Mode,AggressiveMode.prototype.constructor=AggressiveMode,AggressiveMode.prototype._endTurn=function(){battle.players[1].endTurn(),battle.currentPlayer=1;var t=battle.getCurrentPlayer().gold;battle.addGold(),t!==battle.getCurrentPlayer().gold&&game.add.audio("coin").play(),battle.getCurrentPlayer().onTurnStart(battle.map,battle.currentPlayer);var e={font:"65px Arial",fill:"#ff0044",align:"center",stroke:"white",strokeThickness:5},a=game.add.text(game.world.centerX-210,game.world.centerY-300,"Player 1 Turn",e);a.anchor.set(.5),a.alpha=1;game.add.tween(a).to({alpha:0},2e3,"Linear",!0);battle.turn++,turnCount.setText("Turn: "+battle.turn),currentPlayerText.setText("Player "+this.battle.currentPlayer),currentPlayerGold.setText("Gold: "+this.battle.players[battle.currentPlayer-1].gold)},AggressiveMode.prototype._getEnemyHQPos=function(){var t=this,e=null,a=(this.battle.players[0],this.battle.map.getAllBuildings(!0));return a.forEach(function(a){"castle"===a[0].name&&1===parseInt(a[0].owner)&&(e=t._getBarracksPosition(a))}),console.log(e),e},AggressiveMode.prototype._getDistanceBetween=function(t,e){return Math.sqrt(Math.pow(Math.abs(t.x-e.x),2)+Math.pow(Math.abs(t.y-e.y),2))},AggressiveMode.prototype.arrayIncludesPosition=function(t,e){var a=!1;return t.forEach(function(t){if(e.equals(t))return void(a=!0)}),a},AggressiveMode.prototype.handleComputerMove=function(){var t;return this.buildPhase===!0?"buildUnit"!==this.battle.turnState?this._isOpenBarracks()&&this.battle.getCurrentPlayer().gold>=100?t=this._selectNextBarracks():(this.buildPhase=!1,this._endTurn()):"buildUnit"===this.battle.turnState&&(t=this._findUnitMousePos()):t="selectingUnit"===this.battle.turnState?this._selectNextUnit():"selectingMove"===this.battle.turnState?this._selectNextMove():"selectingAttack"===this.battle.turnState?this._selectNextAttack():"capturePrompt"===this.battle.turnState?this._selectNextCapture():new Pos(1,1),t},AggressiveMode.prototype._unitOnMyBarracks=function(t){return!!this.battle.getUnitAtPos(t)},AggressiveMode.prototype._isOpenBarracks=function(){var t=this._getAllMyOpenBarracks();return t.length>0},AggressiveMode.prototype._getAllMyBarracksPositions=function(){var t=this,e=[];return this._getAllBarracks().forEach(function(a){e.push(t._getBarracksPosition(a))}),e},AggressiveMode.prototype._getAllMyOpenBarracks=function(){var t=this,e=[];return this._getAllMyBarracksPositions().forEach(function(a){t._unitOnMyBarracks(a)||e.push(a)}),e},AggressiveMode.prototype._selectNextBarracks=function(){if(this._isOpenBarracks()){var t=this._getAllMyOpenBarracks()[0];return this.battle.currentSelectedTile=this.battle.map.getTileAtPos(t),t}return null},AggressiveMode.prototype._getAllBarracks=function(){var t=this,e=[];return this.battle.map.getAllBuildings(!0).forEach(function(a){"barracks"===a[0].name&&parseInt(a[0].owner)===t.battle.currentPlayer&&e.push(a)}),e},AggressiveMode.prototype._getBarracksPosition=function(t){var e=new Pos(parseInt(t[1]),parseInt(t[2]));return e},AggressiveMode.prototype._getMostExpensiveAffordableUnit=function(){var t=this.battle.getCurrentPlayer().armyType(),e=null,a=null,i=0,n=-1,s=[];for(var r in UNITS[t])n+=1,UNITS[t][r]>i&&UNITS[t][r]<=this.battle.getCurrentPlayer().gold&&(i=UNITS[t][r],e=r,a=n);return s.push(e),s.push(a),s},AggressiveMode.prototype._findUnitMousePos=function(){var t=this._getMostExpensiveAffordableUnit(),e=(t[0],t[1]),a=new Pos(5,3+e);return a},AggressiveMode.prototype._selectNextUnit=function(){var t=null,e=this;return this.battle.players[1].army.units.forEach(function(a){t||a.movedThisTurn||(e.currentSelectedUnit=a,t=a.pos)}),null===t&&(this.buildPhase=!0),t},AggressiveMode.prototype._selectNextMove=function(){var t=this,e=null,a=this.currentSelectedUnit.getPossibleMoves(this.currentSelectedUnit.pos,this.battle.map,this.battle.enemyPositions()),i=this._filterPossibleMoves(a);return e=this.currentSelectedUnit instanceof UnitArtillery?t._handleArtilleryMovement(i):this._randomizeUnitMovement(i)},AggressiveMode.prototype._selectNextAttack=function(){var t=this.currentSelectedUnit.getPossibleAttacks(this.battle.map),e=this._filterPossibleAttackMoves(t);return e[0]},AggressiveMode.prototype._selectNextCapture=function(){return this.currentSelectedUnit.pos},AggressiveMode.prototype._filterPossibleMoves=function(t){var e=this;return result=[],t.forEach(function(t){var a=e.battle.getUnitAtPos(t);a||result.push(t)}),result},AggressiveMode.prototype._filterPossibleAttackMoves=function(t){var e=this;return result=[],t.forEach(function(t){var a=e.battle.getUnitAtPos(t);a&&a.player!==e.currentSelectedUnit.player&&result.push(t)}),result},AggressiveMode.prototype._getClosestMoveToEnemyHQ=function(t){var e=this;return bestMove=null,bestMoveDistance=100,t.forEach(function(t){var a=e._getDistanceBetween(e.enemyHQPos,t);a<bestMoveDistance&&(bestMove=t,bestMoveDistance=a)}),bestMove},AggressiveMode.prototype._getClosestMoveToEnemyUnit=function(t){var e=this;return bestMove=null,bestMoveDistance=100,this.battle.enemyPositions().forEach(function(a){t.forEach(function(t){var i=e._getDistanceBetween(a,t);i<bestMoveDistance&&(bestMove=t,bestMoveDistance=i)})}),bestMove},AggressiveMode.prototype._randomizeUnitMovement=function(t){var e=null;return e=Math.random()>.5?this._getClosestMoveToEnemyHQ(t):this._getClosestMoveToEnemyUnit(t)},AggressiveMode.prototype._handleArtilleryMovement=function(t){var e=null,a=Math.random();return e=a>.5?this.currentSelectedUnit.pos:this._randomizeUnitMovement(t)},DefaultMode.prototype=new Mode,DefaultMode.prototype.constructor=DefaultMode,DefaultMode.prototype.execute=function(){return nextMode="aggressive",nextMode},DefensiveMode.prototype=new Mode,DefensiveMode.prototype.constructor=DefensiveMode,DefensiveMode.prototype.execute=function(){return nextMode="defensive",console.log("Implementing execute function"),nextMode},DefensiveMode.prototype._getFriendlyHQPos=function(){var t=this,e=null,a=(this.battle.players[0],this.battle.map.getAllBuildings(!0));return a.forEach(function(a){"castle"===a[0].name&&2===parseInt(a[0].owner)&&(e=t._getBarracksPosition(a))}),e},DefensiveMode.prototype._randomizeUnitMovement=function(t){var e=null;return e=Math.random()>.5?this._getClosestMoveToFriendlyHQ(t):this._getClosestMoveToEnemyUnit(t)},DefensiveMode.prototype._getClosestMoveToFriendlyHQ=function(t){var e=this;return bestMove=null,bestMoveDistance=100,t.forEach(function(t){var a=e._getDistanceBetween(e._getFriendlyHQPos(),t);a<bestMoveDistance&&(bestMove=t,bestMoveDistance=a)}),bestMove},PatrolMode.prototype=new Mode,PatrolMode.prototype.constructor=PatrolMode,PatrolMode.prototype.execute=function(){return nextMode="patrol",console.log("Implementing execute function"),nextMode},Biplane.prototype=new UnitFlying,Biplane.prototype.constructor=Biplane,Cannon.prototype=new UnitArtillery,Cannon.prototype.constructor=Cannon,Grenadier.prototype=new UnitInfantry,Grenadier.prototype.constructor=Grenadier,IronGuard.prototype=new UnitInfantry,IronGuard.prototype.constructor=IronGuard,Mech.prototype=new UnitInfantry,Mech.prototype.constructor=Mech,Mortar.prototype=new UnitArtillery,Mortar.prototype.constructor=Mortar,MotorBike.prototype=new UnitInfantry,MotorBike.prototype.constructor=MotorBike,Warrior.prototype=new UnitInfantry,Warrior.prototype.constructor=Warrior,Arcanist.prototype=new UnitInfantry,Arcanist.prototype.constructor=Arcanist,Ballista.prototype=new UnitArtillery,Ballista.prototype.constructor=Ballista,EagleWatch.prototype=new UnitFlying,EagleWatch.prototype.constructor=EagleWatch,Elite.prototype=new UnitInfantry,Elite.prototype.constructor=Elite,Longbow.prototype=new UnitInfantry,Longbow.prototype.constructor=Longbow,Ranger.prototype=new UnitCavalry,Ranger.prototype.constructor=Ranger,SilverLancer.prototype=new UnitCavalry,SilverLancer.prototype.constructor=SilverLancer,Valkyrie.prototype=new UnitCavalry,Valkyrie.prototype.constructor=Valkyrie,Berserker.prototype=new UnitInfantry,Berserker.prototype.constructor=Berserker,BloodWing.prototype=new UnitFlying,BloodWing.prototype.constructor=BloodWing,Catapult.prototype=new UnitArtillery,Catapult.prototype.constructor=Catapult,GilaMonster.prototype=new UnitCavalry,GilaMonster.prototype.constructor=GilaMonster,Impaler.prototype=new UnitInfantry,Impaler.prototype.constructor=Impaler,Salamander.prototype=new UnitCavalry,Salamander.prototype.constructor=Salamander,Warmonger.prototype=new UnitInfantry;Warmonger.prototype.constructor=Warmonger;Wyvern.prototype=new UnitFlying,Wyvern.prototype.constructor=Wyvern;